---
title: Malwaric Analysis - Análisis estático de muestras de malware utilizando Malwaric
time: 2024-12-07 12:00:00
categories: [Infosec, Malware Analysis]
tags: [Infosec, Malware Analysis]
image: /assets/posts/Malwaric_Analysis/image.jpg
---

El análisis estático de malware es una de las primeras líneas de defensa para entender el comportamiento de una amenaza antes de ejecutarla. En este post, utilizaré una herramienta creada por mi [Malwaric](https://github.com/Pwn2Ninj4/Malwaric/) para examinar unas muestras específica y desglosar los resultados obtenidos, destacando cómo esta herramienta puede facilitar la identificación de patrones, indicadores de compromiso (IoCs) y posibles vectores de ataque.

# Empezando
En las siguientes lineas estare analizando una muestra de malware conocido:

- Muestra de Nostart.exe(Trojan.Win32)

## Nostart

### Descripción 

Este es un programa para el sistema Windows. Al ejecutarse, permanece en la memoria del sistema y no realiza ninguna acción hasta el momento en que se presiona el botón "Inicio". En ese momento, el troyano activa su rutina, que limpia la pantalla y detiene el sistema. El reinicio solo es posible mediante un reinicio en frío.

### Metadatos
Obtenemos los metadatos del archivo bajo el análisis.
```bash
[◑] Analyzing Nostart.exe...Done
[0xNostart.exe]> m/d

File Size:      238592
File Type:      PE
Time Stamp:     1734328041.670459
Extension:      .exe
Entry Point:    0x30284
Subsystem:      2
```
### Strings
```bash
[0xNostart.exe]> v/s
[◑] Listing binary strings...Done

RegQueryValueExA
RegOpenKeyExA
RegCloseKey
oleaut32.dll
VariantChangeTypeEx
VariantCopyInd
VariantClear
SysStringLen
SysFreeString
SysReAllocStringLen
SysAllocStringLen
kernel32.dll
TlsSetValue
TlsGetValue
LocalAlloc
GetModuleHandleA
GetModuleFileNameA
advapi32.dll
RegQueryValueExA
RegOpenKeyExA
RegCloseKey
kernel32.dll
4K5R5+6?6c6m6w6
< <(<,<4<8<@<D<S<_<s<
= =$=(=,=0=4=8=<=@=D=H=L=P=T=X=\=`=d=h=t=
> >$>(>,>0>4>8><>@>D>H>L>P>T>X>\>`>d>h>l>p>t>x>|>
?)?0?<?@?]?p?
2 2$2(2,2024282<2@2D2H2L2P2T2X2\2`2d2h2l2p2t2x2
1 1$1(1,1014181<1@1D1H1L1P1T1X1\1`1d1h1l1p1t1x1|1
2$2,242<2D2L2T2\2d2l2t2|2
3 3(30383@3H3P3X3`3h3p3x3
```
Analizando las strings vemos strings obsfuscadas y strings sospechosas.

### Secciones.
```bash
[0xNostart.exe]> s/e
[◑] Analyzing sections...Done
Section:CODE
    Virtual Address: 0x1000
    Virtual Size: 0x2f314
    Data Size: 0x2f400                                                                                    Permissions: X, W
    Entropy: 6.489735426787917
Section:DATA
    Virtual Address: 0x31000
    Virtual Size: 0xad8
    Data Size: 0xc00
    Permissions: W, R
    Entropy: 3.7746314736647935
Section:BSS
    Virtual Address: 0x32000
    Virtual Size: 0x785
    Data Size: 0x0
    Permissions: W, R
    Entropy: 0.0
Section:.idata
    Virtual Address: 0x33000
    Virtual Size: 0x1c68
    Data Size: 0x1e00
    Permissions: W, R
    Entropy: 4.807476272250428
Section:.tls
    Virtual Address: 0x35000
    Virtual Size: 0x8
    Data Size: 0x0
    Permissions: W, R
    Entropy: 0.0
Section:.rdata
    Virtual Address: 0x36000
    Virtual Size: 0x18
    Data Size: 0x200
    Permissions: W
    Entropy: 0.2044881574398449
Section:.reloc
    Virtual Address: 0x37000
    Virtual Size: 0x3430
    Data Size: 0x3600
    Permissions: W
    Entropy: 6.593704239971325
Section:.rsrc
    Virtual Address: 0x3b000
    Virtual Size: 0x4a00
    Data Size: 0x4a00
    Permissions: W
    Entropy: 4.296309188965899
```
Al analizar las secciones podemos ver que existe una sección raramente llamada `CODE`, la cual cuenta con permisos de escritura y ejecución(X, W) y la entropía al no ser tan alta si llega a ser alarmante para esta sección.

### API CALLS
![API_CALLS](/assets/posts/Malwaric_Analysis/Nostart/api_calls.jpg)

**Malicious API CALLS**
- Gestión de memoria dinámica: `VirtualAlloc`, `VirtualFree`

- Manipulación de archivos: `WriteFile`, `ReadFile`, `SetFilePointer`

- Cargar y ejecutar código dinámico: `LoadLibraryA`, `GetProcAddress`, `CreateThread`

- Acceso al registro: 
`RegCloseKey`

### DLLs

Listando las librerías importadas(DLLs) por la muestra.

![dll1](/assets/posts/Malwaric_Analysis/Nostart/dll1.jpg)
![dll2](/assets/posts/Malwaric_Analysis/Nostart/dll2.jpg)

### Recursos embebidos

Extraemos posibles recursos embebidos dentro de la muestra.
```bash
[0xNostart.exe]> x/e

Embed Resource: Nostart.exe_resource_1_1_0
Embed Resource: Nostart.exe_resource_1_2_0
Embed Resource: Nostart.exe_resource_1_3_0
Embed Resource: Nostart.exe_resource_1_4_0
Embed Resource: Nostart.exe_resource_1_5_0
Embed Resource: Nostart.exe_resource_1_6_0
Embed Resource: Nostart.exe_resource_1_7_0
Embed Resource: Nostart.exe_resource_2_2248_0
Embed Resource: Nostart.exe_resource_2_2264_0
Embed Resource: Nostart.exe_resource_2_2276_0
Embed Resource: Nostart.exe_resource_2_2294_0
Embed Resource: Nostart.exe_resource_2_2310_0
Embed Resource: Nostart.exe_resource_2_2324_0
Embed Resource: Nostart.exe_resource_2_2342_0
Embed Resource: Nostart.exe_resource_2_2352_0
Embed Resource: Nostart.exe_resource_2_2362_0
Embed Resource: Nostart.exe_resource_2_2378_0
Embed Resource: Nostart.exe_resource_3_1_2057
Embed Resource: Nostart.exe_resource_3_2_2057
Embed Resource: Nostart.exe_resource_6_4085_0
Embed Resource: Nostart.exe_resource_6_4086_0
Embed Resource: Nostart.exe_resource_6_4087_0
Embed Resource: Nostart.exe_resource_6_4088_0
Embed Resource: Nostart.exe_resource_6_4089_0
Embed Resource: Nostart.exe_resource_6_4090_0
Embed Resource: Nostart.exe_resource_6_4091_0
Embed Resource: Nostart.exe_resource_6_4092_0
Embed Resource: Nostart.exe_resource_6_4093_0
Embed Resource: Nostart.exe_resource_6_4094_0
Embed Resource: Nostart.exe_resource_6_4095_0
Embed Resource: Nostart.exe_resource_6_4096_0
Embed Resource: Nostart.exe_resource_10_2390_0
Embed Resource: Nostart.exe_resource_10_2404_0
Embed Resource: Nostart.exe_resource_10_2428_0
Embed Resource: Nostart.exe_resource_10_2442_0
Embed Resource: Nostart.exe_resource_12_32761_0
Embed Resource: Nostart.exe_resource_12_32762_0
Embed Resource: Nostart.exe_resource_12_32763_0
Embed Resource: Nostart.exe_resource_12_32764_0
Embed Resource: Nostart.exe_resource_12_32765_0
Embed Resource: Nostart.exe_resource_12_32766_0
Embed Resource: Nostart.exe_resource_12_32767_0
Embed Resource: Nostart.exe_resource_14_2456_2057
```
### Análisis usando Virus Total

Analizamos la muestra utilizando la base de datos y los motores de AV de Virus Total para detectar firmas similares del malware.

```bash
[0xNostart.exe]> f/s
[◑] Preparing to analyze the file with VirusTotal...Done

+-------------------------+-----------+----------------------------------+
|Lionic         | malicious | Trojan.Win32.Nostart.tsCG        |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|Elastic        | malicious | malicious (high confidence)      |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|CTX            | malicious | exe.trojan.nostart               |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|CAT-QuickHeal  | malicious | Trojan.Ghanarava.17300798522d25f8 |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|Skyhigh        | malicious | BehavesLike.Win32.Infected.dh    |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|ALYac          | malicious | Trojan.NoStart.A                 |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|Malwarebytes   | malicious | Malware.AI.4104721770            |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|Zillya         | malicious | Trojan.Nostart.Win32.1           |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|Sangfor        | malicious | Trojan.Win32.Nostart.Venb        |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|CrowdStrike    | malicious | win/malicious_confidence_100% (W) |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|Alibaba        | malicious | Trojan:Win32/Nostart.1c340f9d    |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|K7GW           | malicious | Riskware ( 0040eff71 )           |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|K7AntiVirus    | malicious | Riskware ( 0040eff71 )           |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|Arcabit        | malicious | Trojan.NoStart.A                 |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|VirIT          | malicious | Trojan.Win32.Generic.HXL         |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|Symantec       | malicious | ML.Attribute.HighConfidence      |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|ESET-NOD32     | malicious | Win32/NoStart                    |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|Paloalto       | malicious | generic.ml                       |
+-------------------------+-----------+----------------------------------+
+-------------------------+-----------+----------------------------------+
|Kaspersky      | malicious | Trojan.Win32.Nostart             |
+-------------------------+-----------+----------------------------------+
```

Estos son algunos AV que detectan la muestra como maliciosa(Es una muestra bastante conocida)

### Guardamos el report en nuestra base de datos

```bash
[0xNostart.exe]> create_db
[◑] Creating database...Done

[0xNostart.exe]> save
        >Add a status: malicious
        >Add the engines that detected "malicious": 30+
        >Add a note: This is a sample Nonstart Trojan
[◑] Saving analysis in the database...Done

[0xNostart.exe]> view_db
[◑] Loading Database...Done
(1, 'Nostart.exe', '20fa439e1f64c8234d21c4bc102d25f8', '2024-12-16 01:02:32', 'malicious', '30+', 'This is a sample Nonstart Trojan')
```

Este post es solo una vista y una prueba de la herramienta Malwaric la cual esta en desarrollo.

Gracias por leer :)

